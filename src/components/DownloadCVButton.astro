---
interface Props {
  cvPath?: string;
  showAfterScroll?: number;
}

const { cvPath = '/downloads/frank-palmisano-cv.pdf', showAfterScroll = 300 } = Astro.props;
---

<a
  id="download-cv-fab"
  href={cvPath}
  download
  aria-label="Download CV"
  class="fixed bottom-6 right-6 z-50 flex h-14 w-14 items-center justify-center rounded-full bg-primary text-primary-foreground shadow-lg transition-all duration-300 ease-out hover:scale-110 hover:shadow-xl hover:shadow-primary/25 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 focus:ring-offset-background opacity-0 translate-y-4 pointer-events-none group"
  data-show-after={showAfterScroll}
>
  <!-- Download icon with animation -->
  <svg
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    viewBox="0 0 24 24"
    fill="none"
    stroke="currentColor"
    stroke-width="2"
    stroke-linecap="round"
    stroke-linejoin="round"
    class="transition-transform duration-300 group-hover:translate-y-0.5"
  >
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
    <polyline points="7 10 12 15 17 10"></polyline>
    <line x1="12" y1="15" x2="12" y2="3"></line>
  </svg>

  <!-- Tooltip -->
  <span
    class="absolute right-full mr-3 whitespace-nowrap rounded-md bg-popover px-3 py-1.5 text-sm font-medium text-popover-foreground shadow-md opacity-0 transition-opacity duration-200 group-hover:opacity-100 pointer-events-none"
  >
    Download CV
  </span>

  <!-- Pulse ring animation -->
  <span
    class="absolute inset-0 rounded-full bg-primary opacity-0 group-hover:animate-ping group-hover:opacity-20"
  ></span>
</a>

<script>
  const initDownloadFab = () => {
    const fab = document.getElementById('download-cv-fab');
    if (!fab) return;

    const showAfter = parseInt(fab.dataset.showAfter || '300', 10);
    let isVisible = false;

    const updateVisibility = () => {
      const shouldShow = window.scrollY > showAfter;

      if (shouldShow && !isVisible) {
        fab.classList.remove('opacity-0', 'translate-y-4', 'pointer-events-none');
        fab.classList.add('opacity-100', 'translate-y-0', 'pointer-events-auto');
        isVisible = true;
      } else if (!shouldShow && isVisible) {
        fab.classList.add('opacity-0', 'translate-y-4', 'pointer-events-none');
        fab.classList.remove('opacity-100', 'translate-y-0', 'pointer-events-auto');
        isVisible = false;
      }
    };

    // Initial check
    updateVisibility();

    // Throttled scroll handler
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          updateVisibility();
          ticking = false;
        });
        ticking = true;
      }
    });
  };

  // Initialize on load
  initDownloadFab();

  // Re-initialize after Astro page transitions
  document.addEventListener('astro:after-swap', initDownloadFab);
</script>
