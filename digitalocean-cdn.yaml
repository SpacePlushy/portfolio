# Digital Ocean Spaces CDN Configuration
# This file configures CDN settings for Digital Ocean App Platform deployment

name: portfolio-cdn
description: CDN configuration for portfolio website deployed on Digital Ocean

# Origin configuration
origin:
  domain: your-app.ondigitalocean.app
  protocol: https
  port: 443
  
# CDN settings
cdn:
  # Enable CDN for the entire site
  enabled: true
  
  # Custom domain (if you have one)
  custom_domain: your-domain.com
  
  # SSL/TLS settings
  ssl:
    certificate_type: lets_encrypt
    force_https: true
    hsts_enabled: true
    hsts_max_age: 31536000
    hsts_include_subdomains: true
    hsts_preload: true
  
  # Cache behavior rules
  cache_behaviors:
    # Static assets - aggressive caching
    - path_pattern: "*.{css,js,png,jpg,jpeg,gif,webp,avif,svg,ico,woff,woff2,ttf,eot,otf}"
      cache_policy:
        cache_duration: 31536000  # 1 year
        cache_headers: 
          - "Cache-Control: public, max-age=31536000, s-maxage=31536000, immutable"
        compress: true
        query_string_forwarding: ignore
        headers_forwarding: 
          - "Accept-Encoding"
          - "Accept"
    
    # Images - moderate caching with optimization
    - path_pattern: "/images/*"
      cache_policy:
        cache_duration: 2592000  # 30 days
        cache_headers:
          - "Cache-Control: public, max-age=86400, s-maxage=2592000, stale-while-revalidate=86400"
        compress: true
        image_optimization: true
        webp_conversion: true
    
    # HTML pages - short cache with revalidation
    - path_pattern: "*.html"
      cache_policy:
        cache_duration: 86400  # 1 day at edge
        cache_headers:
          - "Cache-Control: public, max-age=300, s-maxage=86400, stale-while-revalidate=3600"
        compress: true
        query_string_forwarding: all
        headers_forwarding:
          - "Accept-Encoding"
          - "Accept-Language"
          - "Accept"
    
    # Root path and pages without extension
    - path_pattern: "/"
      cache_policy:
        cache_duration: 86400
        cache_headers:
          - "Cache-Control: public, max-age=300, s-maxage=86400, stale-while-revalidate=3600"
        compress: true
        query_string_forwarding: all
        headers_forwarding:
          - "Accept-Encoding"
          - "Accept-Language"
          - "Accept"
    
    # API routes - no caching
    - path_pattern: "/api/*"
      cache_policy:
        cache_duration: 0
        cache_headers:
          - "Cache-Control: no-cache, no-store, must-revalidate, private"
        compress: false
        query_string_forwarding: all
        headers_forwarding: all

  # Security settings
  security:
    # DDoS protection
    ddos_protection: true
    
    # Rate limiting
    rate_limiting:
      enabled: true
      rules:
        - path: "/api/*"
          requests_per_minute: 30
          burst_size: 10
        - path: "/*"
          requests_per_minute: 200
          burst_size: 50
    
    # Web Application Firewall
    waf:
      enabled: true
      mode: "log"  # Change to "block" in production
      rules:
        - name: "Block suspicious user agents"
          condition: "http.user_agent contains 'bot' and not http.user_agent contains 'googlebot'"
          action: "challenge"
        - name: "Rate limit scraping attempts"
          condition: "http.request.uri.path matches '/robots.txt' or http.request.uri.path matches '/sitemap.xml'"
          action: "rate_limit"
          rate_limit: 10
  
  # Performance optimizations
  performance:
    # Compression
    compression:
      enabled: true
      algorithms: ["br", "gzip"]
      types:
        - "text/html"
        - "text/css"
        - "text/javascript"
        - "application/javascript"
        - "application/json"
        - "application/xml"
        - "image/svg+xml"
    
    # Image optimization
    image_optimization:
      enabled: true
      formats: ["webp", "avif"]
      quality: 85
      auto_format: true
    
    # HTTP/2 and HTTP/3
    protocols:
      http2: true
      http3: true
      
    # Early hints
    early_hints: true
    
    # Connection optimization
    tcp_optimization: true
    keep_alive: true

# Monitoring and analytics
monitoring:
  # Real User Monitoring
  rum:
    enabled: true
    sample_rate: 100
  
  # Log retention
  logs:
    retention_days: 30
    fields:
      - timestamp
      - request_id
      - client_ip
      - method
      - path
      - status_code
      - response_time
      - cache_status
      - bytes_sent
      - user_agent
      - referrer

# Environment-specific settings
environments:
  development:
    cache_duration_override: 0
    debug_headers: true
    waf_mode: "off"
  
  staging:
    cache_duration_override: 300
    debug_headers: true
    waf_mode: "log"
  
  production:
    debug_headers: false
    waf_mode: "block"
    
# Purge settings
purge:
  # Automatic purge on deployment
  auto_purge_on_deploy: true
  
  # Purge by tags
  tags:
    static_assets: ["css", "js", "images"]
    pages: ["html", "home", "portfolio"]
    api: ["api"]