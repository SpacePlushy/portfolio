# =============================================================================
# PROMETHEUS ALERTING RULES
# =============================================================================
# Comprehensive alerting for the portfolio application with lifecycle monitoring
# Updated for zero-downtime deployment and advanced health checking

groups:
  - name: system_health
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} on instance {{ $labels.instance }} has been down for more than 1 minute"
          runbook_url: "https://wiki.company.com/runbooks/service-down"

      - alert: HighCPUUsage
        expr: 100 - (avg(rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High CPU usage detected"
          description: "CPU usage is above 80% for more than 5 minutes"

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High memory usage detected"
          description: "Memory usage is above 85% for more than 5 minutes"

      - alert: DiskSpaceLow
        expr: (node_filesystem_size_bytes{fstype!="tmpfs"} - node_filesystem_avail_bytes{fstype!="tmpfs"}) / node_filesystem_size_bytes{fstype!="tmpfs"} * 100 > 90
        for: 2m
        labels:
          severity: critical
          category: storage
        annotations:
          summary: "Disk space is running low"
          description: "Disk usage is above 90% on {{ $labels.device }}"

  - name: application_health
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 3m
        labels:
          severity: critical
          category: errors
        annotations:
          summary: "High error rate detected"
          description: "Error rate is above 5% for {{ $labels.job }} service"

      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High response time detected"
          description: "95th percentile response time is above 2 seconds"

      - alert: TooManyRequests
        expr: rate(http_requests_total[1m]) > 1000
        for: 2m
        labels:
          severity: warning
          category: traffic
        annotations:
          summary: "High request rate detected"
          description: "Request rate is above 1000 requests/minute"

  - name: image_optimization
    interval: 30s
    rules:
      - alert: ImageProcessingQueueBacklog
        expr: image_processing_queue_size > 100
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Image processing queue is backing up"
          description: "Queue size is {{ $value }} items, which is above the threshold of 100"

      - alert: ImageProcessingFailureRate
        expr: rate(image_processing_errors_total[5m]) / rate(image_optimizations_total[5m]) * 100 > 10
        for: 3m
        labels:
          severity: critical
          category: errors
        annotations:
          summary: "High image processing failure rate"
          description: "Image processing failure rate is {{ $value }}%, above 10% threshold"

      - alert: SlowImageProcessing
        expr: histogram_quantile(0.95, rate(image_processing_duration_seconds_bucket[5m])) > 30
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Slow image processing detected"
          description: "95th percentile processing time is {{ $value }} seconds, above 30s threshold"

      - alert: LowCacheHitRate
        expr: rate(image_cache_hits_total[5m]) / (rate(image_cache_hits_total[5m]) + rate(image_cache_misses_total[5m])) * 100 < 70
        for: 10m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Low cache hit rate detected"
          description: "Cache hit rate is {{ $value }}%, below 70% threshold"

      - alert: ImageWorkerDown
        expr: image_worker_active == 0
        for: 2m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "All image workers are down"
          description: "No active image processing workers detected"

  - name: redis_health
    interval: 30s
    rules:
      - alert: RedisDown
        expr: redis_up == 0
        for: 1m
        labels:
          severity: critical
          category: database
        annotations:
          summary: "Redis is down"
          description: "Redis instance is not responding"

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Redis memory usage is high"
          description: "Redis memory usage is {{ $value }}%, above 90% threshold"

      - alert: RedisConnectionLimit
        expr: redis_connected_clients > redis_config_maxclients * 0.8
        for: 5m
        labels:
          severity: warning
          category: connections
        annotations:
          summary: "Redis approaching connection limit"
          description: "Redis has {{ $value }} connections, approaching the limit"

      - alert: RedisSlowQueries
        expr: redis_slowlog_length > 10
        for: 2m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Redis slow queries detected"
          description: "Redis slow log has {{ $value }} entries"

  - name: security_alerts
    interval: 60s
    rules:
      - alert: SuspiciousUploadActivity
        expr: rate(image_upload_requests_total{status="rejected"}[5m]) > 10
        for: 2m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Suspicious image upload activity"
          description: "High rate of rejected image uploads: {{ $value }} requests/sec"

      - alert: LargeFileUploadAttempt
        expr: image_upload_size_exceeded_total > 5
        for: 1m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Multiple large file upload attempts"
          description: "{{ $value }} attempts to upload files exceeding size limit"

      - alert: RateLimitTriggered
        expr: rate_limit_exceeded_total > 100
        for: 5m
        labels:
          severity: warning
          category: security
        annotations:
          summary: "Rate limiting triggered frequently"
          description: "Rate limit has been exceeded {{ $value }} times"

  - name: deployment_health
    interval: 30s
    rules:
      - alert: RecentDeploymentIssues
        expr: increase(deployment_failures_total[1h]) > 0
        for: 0m
        labels:
          severity: critical
          category: deployment
        annotations:
          summary: "Deployment failure detected"
          description: "{{ $value }} deployment failures in the last hour"
          runbook_url: "https://github.com/SpacePlushy/portfolio/blob/main/docs/runbooks/deployment-failure.md"

      - alert: HealthCheckFailures
        expr: rate(health_check_failures_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          category: health
        annotations:
          summary: "Health check failures detected"
          description: "Health checks are failing at {{ $value }} failures/sec"
          runbook_url: "https://github.com/SpacePlushy/portfolio/blob/main/docs/runbooks/health-check-failure.md"
      
      - alert: SlowStartupTime
        expr: startup_duration_seconds > 120
        for: 1m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "Application startup taking too long"
          description: "Startup duration is {{ $value }}s, exceeding 120s threshold"
      
      - alert: DependencyInitializationFailure
        expr: dependency_ready{dependency=~"sharp|redis"} == 0
        for: 3m
        labels:
          severity: critical
          category: dependencies
        annotations:
          summary: "Critical dependency initialization failed"
          description: "{{ $labels.dependency }} dependency is not ready after 3 minutes"
      
      - alert: GracefulShutdownTimeout
        expr: shutdown_duration_seconds > 30
        for: 0m
        labels:
          severity: warning
          category: lifecycle
        annotations:
          summary: "Graceful shutdown taking too long"
          description: "Shutdown duration is {{ $value }}s, exceeding 30s threshold"
      
      - alert: FeatureFlagConfigurationError
        expr: feature_flag_error_total > 0
        for: 1m
        labels:
          severity: warning
          category: configuration
        annotations:
          summary: "Feature flag configuration errors detected"
          description: "{{ $value }} feature flag errors in the last minute"
      
      - alert: BackupDeploymentUnavailable
        expr: backup_deployment_available == 0
        for: 5m
        labels:
          severity: warning
          category: deployment
        annotations:
          summary: "Backup deployment not available for rollback"
          description: "No backup deployment available - rollback capability compromised"
      
      - alert: MonitoringStackDegraded
        expr: monitoring_stack_healthy < 1
        for: 2m
        labels:
          severity: warning
          category: monitoring
        annotations:
          summary: "Monitoring stack degraded"
          description: "Monitoring capabilities are degraded - observability compromised"

  - name: business_metrics
    interval: 300s
    rules:
      - alert: LowImageOptimizationVolume
        expr: rate(image_optimizations_total[1h]) < 0.1
        for: 30m
        labels:
          severity: info
          category: business
        annotations:
          summary: "Low image optimization volume"
          description: "Image optimization volume is unusually low: {{ $value }} optimizations/sec"

      - alert: PoorCompressionRatio
        expr: avg_over_time(image_compression_ratio[1h]) < 0.3
        for: 15m
        labels:
          severity: warning
          category: quality
        annotations:
          summary: "Poor image compression performance"
          description: "Average compression ratio is {{ $value }}, below expected 0.3"
      
      - alert: PortfolioPageLoadFailures
        expr: rate(http_requests_total{path=~"/|/software-engineer|/customer-service",status=~"5.."}[5m]) > 0.01
        for: 2m
        labels:
          severity: critical
          category: business
        annotations:
          summary: "Portfolio pages failing to load"
          description: "Critical portfolio pages experiencing {{ $value }} failures/sec"
      
      - alert: UserSessionDropoff
        expr: avg_over_time(user_session_duration_seconds[1h]) < 30
        for: 15m
        labels:
          severity: warning
          category: business
        annotations:
          summary: "Unusually short user sessions"
          description: "Average session duration is {{ $value }}s, below 30s threshold"
  
  - name: lifecycle_monitoring
    interval: 30s
    rules:
      - alert: StartupPhaseStuck
        expr: startup_phase_duration_seconds{phase=~"initializing|dependencies"} > 60
        for: 1m
        labels:
          severity: critical
          category: lifecycle
        annotations:
          summary: "Application stuck in startup phase"
          description: "{{ $labels.phase }} phase has been running for {{ $value }}s"
      
      - alert: HighMemoryDuringStartup
        expr: process_resident_memory_bytes / 1024 / 1024 > 1024 and startup_complete == 0
        for: 2m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "High memory usage during startup"
          description: "Memory usage is {{ $value }}MB during startup, above 1GB threshold"
      
      - alert: ReadinessProbeTimeout
        expr: health_check_duration_seconds{endpoint="/api/readiness"} > 10
        for: 1m
        labels:
          severity: warning
          category: health
        annotations:
          summary: "Readiness probe timeout"
          description: "Readiness check taking {{ $value }}s, above 10s threshold"
      
      - alert: LivenessProbeFailure
        expr: health_check_success{endpoint="/api/health"} == 0
        for: 1m
        labels:
          severity: critical
          category: health
        annotations:
          summary: "Liveness probe failure"
          description: "Health check endpoint failing - application may need restart"